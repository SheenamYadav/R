#--------------------------------------------------------------------------------------------------------------

#LendingClub 

#Analysis of data of the years 2014-2015

#Setting the working directory to the location of the file using "setwd()"

#--------------------------------------------------------------------------------------------------------------

#--------------------------------------------------------------------------------------------------------------




#Reading the data files of the years 2014 and 2015 respectively using "read.csv()"

#LoanStats3c.csv ---> year 2014 data

#LoanStats3d.csv ---> year 2015 data

#storing the 2014 data in to the variable data1

#--------------------------------------------------------------------------------------------------------------


data1<-read.csv('LoanStats3c.csv',skip=1,header=T)


#--------------------------------------------------------------------------------------------------------------

#storing the 2015 data in to the variable data2

#--------------------------------------------------------------------------------------------------------------


data2<-read.csv('LoanStats3d.csv',skip=1,header=T)


#--------------------------------------------------------------------------------------------------------------

#combining both the files in a different variable data3 using "rbind()"

#--------------------------------------------------------------------------------------------------------------


data3<-rbind(data1,data2)


#--------------------------------------------------------------------------------------------------------------

#Checking the combined data by calling the variable data3

#--------------------------------------------------------------------------------------------------------------


data3


#--------------------------------------------------------------------------------------------------------------


#QUESTION 1 : What is the Median Loan Amount ?
#_____________________________________________________________________________________________________________________________________________________________________________________


#Solution

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#fetching the loan_amnt column from the combined data using "$" and storing it into "Loan_Amount" variable

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


Loan_Amount<-data3$loan_amnt


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Reading the loan amount data

#Bound Reached, Increasing the boundary level using "options()"

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


options('max.print'=99999999)


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Reading loan amount data again

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


Loan_Amount


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Arranging data in a column major form using cbind()

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


cbind(Loan_Amount)


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Removing the NA values from Loan_Amount and storing result into "Corrected_Loan_Amount"

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



Corrected_Loan_Amount = na.omit(Loan_Amount)



#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Reading Corrected Loan Amount

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


Corrected_Loan_Amount


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Calculating Median and storing it into MedianLoanAmount

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



MedianLoanAmount<-median(Corrected_Loan_Amount)



#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Reading the Median of the Loan Amount (FINAL SOLUTION FOR QUESTION 1.)

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



MedianLoanAmount



#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#QUESTION 2: Each loan is categorized into a single purpose. What fraction of all loans are for the most common purpose?
#__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________

#SOLUTION :

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Fetching Purpose from the data and storing it into "purpose"

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


purpose<-data3$purpose


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Reading the purpose column

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



purpose


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


cbind(purpose)


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Finding the Occurences of different purposes using "table(unlist(x))" and storing it in "Occurences"

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


Occurences<-table(unlist(purpose))


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Reading the Occurences of different purposes

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


Occurences


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#OBSERVATION :- debt_consolidation is the most common purpose among all the purposes 

#Retrieving the occurence of debt_consolidation and storing it in "most_common"

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


most_common<-Occurences["debt_consolidation"]

most_common


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Calculating the total no. of entries in purpose field and storing it in "Length_Purpose"

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


Length_Purpose<-length(purpose)

Length_Purpose


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Calculating the Fraction and storing it into the "fraction"

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



fraction<-most_common/Length_Purpose



#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#We got the fraction upto 7 decimal place , we will extend it upto 10 decimal places using "options(digits="")"

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



options(digits=10)

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Reading the Fraction Value ( FINAL ANSWER TO QUESTION 2.)

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



fraction



#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#QUESTION3: Calculate the average interest rate across loans for each purpose. What is the ratio of minimum average rate to the maximum average rate? (The ratio should be less than 1.) 

#________________________________________________________________________________________________________________________________________________________________________________________

#Solution.

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Select the purpose column and storing it to "Purposes"

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



Purposes<-data3$purpose



#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Select the interest rate column and storing it into "Rate"

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


Rate<-data3$int_rate


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Storing Rate values in integer form using "as.numeric(sub("%"," ",Rate))/100"

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



Rate1<-as.numeric(sub("%"," ",Rate))/100

intRate<-as.numeric(sub("%"," ",Rate))/100

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Finding each purpose average interest rate calculation using "table(unlist())"

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



names(table(unlist(Purposes)))


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


#We found all the Purposes
#[1] ""                   "car"                "credit_card"       
#[4] "debt_consolidation" "home_improvement"   "house"             
#[7] "major_purchase"     "medical"            "moving"            
#[10] "other"              "renewable_energy"   "small_business"    
#[13] "vacation"           "wedding"            "educational"       


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#finding means of Rates for all the purposes

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------




mean_car<-mean(subset(Rate1,Purposes=="car"))

mean_creditcard<-mean(subset(Rate1,Purposes=="credit_card"))

mean_debt<-mean(subset(Rate1,Purposes=="debt_consolidation"))

mean_home<-mean(subset(Rate1,Purposes=="home_improvement"))

mean_house<-mean(subset(Rate1,Purposes=="house"))

mean_mp<-mean(subset(Rate1,Purposes=="major_purchase"))

mean_med<-mean(subset(Rate1,Purposes=="medical"))
 
mean_mov<-mean(subset(Rate1,Purposes=="moving"))

mean_oth<-mean(subset(Rate1,Purposes=="other"))

mean_re<-mean(subset(Rate1,Purposes=="renewable_energy"))

mean_sb<-mean(subset(Rate1,Purposes=="small_business"))

mean_vac<-mean(subset(Rate1,Purposes=="vacation"))

mean_wed<-mean(subset(Rate1,Purposes=="wedding",na.rm=T))

mean_edu<-mean(subset(Rate1,Purposes=="educational"))




#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Finding maximum of all means using the function max()

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



Maxmean<-max(mean_car,mean_creditcard,mean_debt,mean_home,mean_house,mean_mp,mean_med,mean_mov,mean_oth,mean_re,mean_sb,mean_vac,mean_wed,mean_edu)

Minmean<-min(mean_car,mean_creditcard,mean_debt,mean_home,mean_house,mean_mp,mean_med,mean_mov,mean_oth,mean_re,mean_sb,mean_vac,mean_wed,mean_edu)

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Finding the ratio of Minmean to Maxmean(FINAL SOLUTION TO QUESTION 3.)

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



Ratio<-Minmean/Maxmean


								
#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#QUESTION 4.  What is the difference in the fraction of the loans with a 36-month term between 2014 and 2015?  

#________________________________________________________________________________________________________________________________________________________________________________________


#SOLUTION:

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Fetching term from 2014 data and storing it into "Term1"

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


Term1<-(data1$term)

count<-(unlist(table(Term1)))


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Storing the count using the index of 36 months

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



calc1<-count[2]


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Fraction calculation for 2014 "frac2014"

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


frac2014<-calc1/length(Term1)


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Fetching term from 2015 data and storing it into "Term2"

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


Term2<-(data2$term)

count2<-(unlist(table(Term2)))


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Storing the count using the index of 36 months

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


calc2<-count2[2]


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Fraction Calculation for 2015 "frac2015"

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


frac2015<-calc2/length(Term2)


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Storing the final result(difference) into "Result" (FINAL SOLUTION TO QUESTION 4.)

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



Result<-frac2014-frac2015



#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


Question5. I will consider all loans that are not in the 'Fully Paid', 'Current', 'In Grace Period' statuses to be in default. Calculate the ratio of the time spent paying the loan, defined as the 

difference between the last payment date and the issue date, divided by the term of loan. What is the standard deviation of this ratio for all the loans in default? 

#________________________________________________________________________________________________________________________________________________________________________________________________________

#Solution:

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Storing the loan_status to Var "Status"

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


Status<-data3$loan_status


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Extracting the Required Subset

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


Default<-subset(data3,Status!='Fully Paid' & Status!='Current'& Status!='In Grace Period')


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Storing Issued and Last Payment dates to respective variables

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


Issued_date<-subset(data3$issue_d,Status!='Fully Paid' & Status!='Current'& Status!='In Grace Period')

last_payment_date<-subset(data3$last_pymnt_d,Status!='Fully Paid' & Status!='Current'& Status!='In Grace Period')

I_date<-paste("01-", Issued_date , sep = "")
 
Issued_date1<-as.Date(I_date, format = "%d-%b-%Y")

P_date<-paste("01-", last_payment_date , sep = "")

Payment_Date1<-as.Date(P_date, format = "%d-%b-%Y")


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Final Calculation(SOLUTION TO QUESTION 5)

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

 
Time_Spent<- (Payment_Date1 - Issued_date1)

term<-as.numeric(gsub("months" ,"" ,Default$term))

ratio<-Time_Spent/(term*30)

S.D.<-sd(ratio,na.rm=TRUE)


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#QUESTION 6.  What is the Mean, Median, Mean Absolute Deviation, Variance, IQR, Skewness and Kurtosis for the total rate of return, as figured from the total payments and the loan amount, and the interest rate? Consider only loans that have reached the end of their term. [Summary function NOT to be used here]

#____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________

data3<-cbind(data3,intRate)

Paid_loan<-subset(data3,loan_status=="Fully Paid")

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Calculating Return Rate

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

 
new<-as.numeric(Paid_loan$loan_amnt*Paid_loan$Rate1)+as.numeric(Paid_loan$loan_amnt)

new2<-new - Paid_loan$total_pymnt

Ret_Rate<-new2/Paid_loan$loan_amnt


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Calculation of Mean,Median,MeanAbsoluteDeviation,Variance,IQR and Moments (SOLUTION FOR QUESTION 6.)

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#library(lsr) : for mean abs. deviation 

#library(moments) : for Skewness and Kurtosis

library(lsr) 

library(moments)

MeanRR<-mean(Ret_Rate,na.rm=TRUE)

MedianRR<-median(Ret_Rate,na.rm=TRUE)

mean_abs_devRR<-aad(Ret_Rate,na.rm=TRUE)

varianceRR<-var(Ret_Rate,na.rm=TRUE)

skewnessRR<-skewness(Ret_Rate,na.rm=TRUE)

KurtosisRR<-kurtosis(Ret_Rate,na.rm=TRUE)

IQR_RR<- IQR(Ret_Rate,na.rm=TRUE)


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#QUESTION7. Let's find a loan purpose that shows up abnormally often in one state. Call A the probability of a loan going to a specific purpose nationwide. Call B the probability of a loan going to a specific purpose for each state. Out of all (state, purpose) pairs with at least 10 loans, what is the highest ratio of B / A (i.e. the most surprising)?

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


library(dplyr)

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#dataset for calculating A : NATIONWIDE

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



data_A<-table(data3$purpose)



#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#total number or sample space 

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------




data_A_total<-length(data3$purpose)



#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#number of different purposes in the data

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


data_A_length<-length(data_A)

names(data_A)[1]<-"OTHERS"



#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#to store probabilities of various purposes 

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



prob_A<-vector("numeric",length=data_A_length)
for (i in 1:data_A_length)
{
  prob_A[i]<-data_A[i]/data_A_total
}



#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#dataset for calculating B : STATEWISE

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------




NumStates<-length(table(data3$addr_state))
maxRatio<-0
for( i in 1:NumStates)
{  
  addrState<-names(table(data3$addr_state))[i]
  data_B<-subset(totaldata,addr_state==addrState)
  tbl<-table(data_B$purpose)
  l_tbl<-length(tbl)
  T_tbl<-length(data_B$purpose)
  for (j in 1:l_tbl)
  {      if(tbl[j]>=10)
  {    prob_purpose_state<-tbl[j]/T_tbl
  ratio<-prob_purpose_state/prob_A[j]
  if (maxRatio<ratio)
  {maxRatio<-ratio}
  }
  }
}




#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

QUESTION8. Group all loans by their sub-grade and calculate their average interest rate, average default rate, and percentage of loan status categories. 

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Loading the Package Dplyr

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



library(dplyr)



#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#storing data in tabular form

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


loan<-tbl_df(data3)


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Grouping data by sub_grades

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



loan_group<-group_by(loan,sub_grade)

loan_group$intRate

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#Calculating average int_rate

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



avgIR<-mean(loan_group$intRate,na.rm=TRUE)



#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#To calculate Percentage of loan Statuses

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



S_table<-table(loan_group$loan_status)

tot<-length(loan_group$loan_status)

numofcate<-length(names(S_table))



#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#changing names  " " to OTHERS

#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


names(S_table)[1]="OTHERS"


#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------




for(i in 1:numofcate)
{
perc1<-S_table[i]
perc2<-(perc1/tot)*100
print(perc2)

}



#------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
